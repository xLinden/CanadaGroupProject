---
title: "PresentationCode"
author: "Linden W and Alan P"
date: "2025-07-14"
output: html_document
---

## Data Setup

```{r echo = FALSE}
library(tidyr)
library(dplyr)      # data manipulation
library(tidyverse)   # readr, dplyr, ggplot2, etc.
library(lubridate)   # date‑time helpers
library(scales)      # nicer axis labels (optional)
library(randomForest)
library(moments)  # for skewness and kurtosis

set.seed(42)

# === File paths ===
base_path <- "C:/Users/Mr.Me/Documents/"
#base_path <- "/Users/lindenwareing/Desktop/BEX3727/Presentation/ProjectRepo/"

bixi <- read.csv(paste0(base_path, "2024_Bixi_Data.csv"))

bixi <- bixi %>% 
  mutate(
    start_dt  = as_datetime(STARTTIMEMS / 1000, tz = "America/Montreal"),
    end_dt    = as_datetime(ENDTIMEMS   / 1000, tz = "America/Montreal"),
    trip_min  = as.numeric(difftime(end_dt, start_dt, units = "mins")),
    month     = floor_date(start_dt, "month"),
    weekday   = wday(start_dt, label = TRUE, week_start = 1),  # Mon‑Sun
    hour      = hour(start_dt)
  )

save.image("my_workspace.RData")
load("my_workspace.RData")
```

## Seasonality & hourly patterns

```{r echo = FALSE}

monthly <- bixi %>% count(month)
ggplot(monthly, aes(month, n)) +
  geom_line(linewidth = 1) +
  labs(title = "BIXI 2024 — Monthly Trip Volume",
       x = NULL, y = "Trips") +
  scale_y_continuous(labels = comma)

hourly <- bixi %>% count(hour)

ggplot(hourly, aes(hour, n)) +
  geom_col(fill = "steelblue") +
  labs(title = "Trips by Hour of Day",
       x = "Hour (0 to 23)",
       y = "Trips") +
  scale_y_continuous(
    labels = comma,                 # 1,000,000 instead of 1e+06
    breaks = pretty_breaks()        # “nice” whole‑number breaks
  )


```

```{r}
# Your R code here
# Step 1: Add a season column
bixi <- bixi %>%
  mutate(
    season = case_when(
      month(start_dt) %in% c(12, 1, 2)  ~ "Winter",
      month(start_dt) %in% c(3, 4, 5)   ~ "Spring",
      month(start_dt) %in% c(6, 7, 8)   ~ "Summer",
      month(start_dt) %in% c(9, 10, 11) ~ "Fall"
    ),
    day_type = if_else(weekday %in% c("Sat", "Sun"), "Weekend", "Weekday")
  )

# Step 2: Count trips by season, weekday, and type
wk_season <- bixi %>%
  count(season, weekday, day_type)

# Step 3: Plot: Weekday vs Weekend by Season
ggplot(wk_season, aes(weekday, n, fill = day_type)) +
  geom_col(position = "dodge") +
  facet_wrap(~ season, nrow = 2) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02")) +
  labs(
    title = "Weekday vs Weekend Rides by Season",
    x = NULL, y = "Trips", fill = ""
  ) +
  theme_minimal()






```
```{r}
# Your R code here
# Plot: distribution by season and day_type
ggplot(bixi, aes(trip_min)) +
  geom_histogram(binwidth = 2, fill = "steelblue", alpha = 0.8) +
  coord_cartesian(xlim = c(0, 60)) +
  facet_grid(season ~ day_type) +
  labs(
    title = "Trip Duration Distribution by Season and Day Type (<60 min)",
    x = "Duration (minutes)", y = "Trips"
  ) +
  theme_minimal()

```


## Most Common Routes
```{r echo = FALSE}
bixi <- bixi %>%
  mutate(
    route = paste(STARTSTATIONNAME, "→", ENDSTATIONNAME)
  )

bixi %>% count(route, sort = TRUE)  # Top routes
ggplot(bixi %>% count(route, sort = TRUE) %>% slice_max(n, n = 10),
       aes(x = reorder(route, n), y = n)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Top 10 BIXI Routes", x = "Route", y = "Trips")

### Finding Histogram within trips


# Step 2: Find top 10 most frequent routes
top_routes <- bixi %>%
  count(route, sort = TRUE) %>%
  slice_max(n, n = 10) %>%
  pull(route)  # Extract just the route names

# Step 3: Filter bixi data for only those routes
bixi_top_routes <- bixi %>%
  filter(route %in% top_routes)

# Step 4: Plot histograms (trip duration < 60 min) faceted by route
ggplot(bixi_top_routes, aes(trip_min)) +
  geom_histogram(binwidth = 2, fill = "steelblue", alpha = 0.8) +
  coord_cartesian(xlim = c(0, 60)) +
  facet_wrap(~ route, ncol = 2, scales = "free_y") +
  labs(
    title = "Trip Duration Distribution for Top 10 Routes (<60 min)",
    x = "Duration (minutes)", y = "Trips"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(size = 10))

```

## Pie chart
```{r echo = FALSE}

# Step 1: Count trips by route, rank them
route_counts <- bixi %>%
  count(route, sort = TRUE) %>%
  mutate(rank = row_number())

# Step 2: Create route buckets
route_buckets <- route_counts %>%
  mutate(bucket = case_when(
    rank <= 5000   ~ "Top 1–5000",
    rank <= 10000   ~ "Top 5001–10000",
    rank <= 15000   ~ "Top 10001–15000",
    rank <= 20000   ~ "Top 15001–20000",
    rank <= 25000   ~ "Top 20001–25000",
    rank <= 30000   ~ "Top 25001–30000",
    rank <= 35000   ~ "Top 30001–35000",
    TRUE          ~ "Other"
  ))


# Step 3: Aggregate totals per bucket
bucket_summary <- route_buckets %>%
  group_by(bucket) %>%
  summarise(trips = sum(n), .groups = "drop") %>%
  mutate(
    share = trips / sum(trips),
    share_pct = round(100 * share, 1),
    label = paste0(bucket, "\n", share_pct, "%")
  ) %>%
  arrange(desc(share))

# Step 4: Donut chart
ggplot(bucket_summary, aes(x = 2, y = share, fill = bucket)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  xlim(0.5, 2.5) +
  labs(
    title = "BIXI Route Usage by Frequency Bucket",
    x = NULL, y = NULL, fill = "Route Bucket"
  ) +
  theme_void() +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            size = 3) +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)
  )


```

## travel within trips
```{r echo = FALSE}
# Step 1: Get top 5 routes
top5_routes <- bixi %>%
  count(route, sort = TRUE) %>%
  slice_max(n, n = 5) %>%
  pull(route)

# Step 2: Filter to just those
bixi_top5 <- bixi %>%
  filter(route %in% top5_routes)

# Step 3: Count rides per weekday and season
route_by_weekday <- bixi_top5 %>%
  count(route, weekday, season)

# Step 4: Plot — one facet per route, bars per weekday, colored by season
ggplot(route_by_weekday, aes(x = weekday, y = n, fill = season)) +
  geom_col(position = "dodge") +
  facet_wrap(~ route, ncol = 1, scales = "free_y") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Top 5 BIXI Routes — Usage by Weekday and Season",
    x = "Day of the Week", y = "Trips", fill = "Season"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(size = 10))

```


## Do we travel within Arrondisement
```{r echo = FALSE}
bixi <- bixi %>%
  mutate(
    route_arr = paste(STARTSTATIONARRONDISSEMENT, "→", ENDSTATIONARRONDISSEMENT)
  )
bixi %>% count(route_arr, sort = TRUE)

# Travel within Arrondisment Flag
bixi <- bixi %>%
  mutate(
    same_arrondissement = STARTSTATIONARRONDISSEMENT == ENDSTATIONARRONDISSEMENT
  )

bixi %>% count(same_arrondissement)







```






## ARRONDIMSNET FLOW/MISMATCH
```{r echo = FALSE}
# === Inflows and Outflows ===
inflow <- bixi %>%
  count(ENDSTATIONARRONDISSEMENT, name = "inflow") %>%
  rename(arrondissement = ENDSTATIONARRONDISSEMENT)

outflow <- bixi %>%
  count(STARTSTATIONARRONDISSEMENT, name = "outflow") %>%
  rename(arrondissement = STARTSTATIONARRONDISSEMENT)

# === Combine and calculate net flow ===
flow <- full_join(inflow, outflow, by = "arrondissement") %>%
  mutate(
    inflow = coalesce(inflow, 0),
    outflow = coalesce(outflow, 0),
    net_flow = inflow - outflow
  )

```

### MISMATCH METRICS - INCLUDINGG WITHIN ARRONDISMENT TRIPS
```{r echo = FALSE}
# Top 10 inflows
flow %>%
  top_n(10, inflow) %>%
  ggplot(aes(x = reorder(arrondissement, inflow), y = inflow)) +
  geom_col(fill = "#1f77b4") +
  coord_flip() +
  labs(title = "Top 10 BIXI Inflows by Arrondissement (All Trips)", x = "Arrondissement", y = "Trips In") +
  theme_minimal(base_size = 13)

# Top 10 outflows
flow %>%
  top_n(10, outflow) %>%
  ggplot(aes(x = reorder(arrondissement, outflow), y = outflow)) +
  geom_col(fill = "#ff7f0e") +
  coord_flip() +
  labs(title = "Top 10 BIXI Outflows by Arrondissement (All Trips)", x = "Arrondissement", y = "Trips Out") +
  theme_minimal(base_size = 13)

# Top 10 Net Flow Mismatch
flow %>%
  top_n(10, abs(net_flow)) %>%
  ggplot(aes(x = reorder(arrondissement, net_flow), y = net_flow, fill = net_flow > 0)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  scale_fill_manual(values = c("#ff7f0e", "#1f77b4")) +
  labs(title = "Top 10 BIXI Net Flow Mismatches (All Trips)", x = "Arrondissement", y = "Net Inflow (In - Out)") +
  theme_minimal(base_size = 13)

```


## EXCLUDING INNER ARRODNISMENT TRIPS
```{r echo = FALSE}

# Exclude trips where start == end arrondissement
bixi_cross <- bixi %>%
  filter(STARTSTATIONARRONDISSEMENT != ENDSTATIONARRONDISSEMENT)

# Inflows and Outflows (cross-arrondissement only)
inflow_cross <- bixi_cross %>%
  count(ENDSTATIONARRONDISSEMENT, name = "inflow") %>%
  rename(arrondissement = ENDSTATIONARRONDISSEMENT)

outflow_cross <- bixi_cross %>%
  count(STARTSTATIONARRONDISSEMENT, name = "outflow") %>%
  rename(arrondissement = STARTSTATIONARRONDISSEMENT)

# Combine and calculate net flow
flow_cross <- full_join(inflow_cross, outflow_cross, by = "arrondissement") %>%
  mutate(
    inflow = coalesce(inflow, 0),
    outflow = coalesce(outflow, 0),
    net_flow = inflow - outflow
  )

# Top 10 inflows (cross-only)
flow_cross %>%
  top_n(10, inflow) %>%
  ggplot(aes(x = reorder(arrondissement, inflow), y = inflow)) +
  geom_col(fill = "#2ca02c") +
  coord_flip() +
  labs(title = "Top 10 BIXI Inflows by Arrondissement", x = "Arrondissement", y = "Trips In") +
  theme_minimal(base_size = 13)

# Top 10 outflows (cross-only)
flow_cross %>%
  top_n(10, outflow) %>%
  ggplot(aes(x = reorder(arrondissement, outflow), y = outflow)) +
  geom_col(fill = "#d62728") +
  coord_flip() +
  labs(title = "Top 10 BIXI Outflows by Arrondissement", x = "Arrondissement", y = "Trips Out") +
  theme_minimal(base_size = 13)

# Top 10 net flow mismatches (cross-only)
flow_cross %>%
  top_n(10, abs(net_flow)) %>%
  ggplot(aes(x = reorder(arrondissement, net_flow), y = net_flow, fill = net_flow > 0)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  scale_fill_manual(values = c("#d62728", "#2ca02c")) +
  labs(title = "Top 10 Net Flow Mismatches", x = "Arrondissement", y = "Net Inflow (In - Out)") +
  theme_minimal(base_size = 13)


```

## Attemoting to map by arrondisment
```{r echo = FALSE}
install.packages(c("sf", "ggplot2", "dplyr"))  # If not already installed
library(sf)
library(dplyr)
library(ggplot2)

# Load GeoJSON
arr_map <- st_read("limites-administratives-agglomeration.json")  # downloaded file



# Clean arrondissement names in flow_cross
flow_cross_clean <- flow_cross %>%
  mutate(
    arrondissement_clean = arrondissement %>%
      str_replace_all("–", "-") %>%        # Replace en dash with hyphen
      str_replace_all(" - ", "-") %>%      # Remove space around dash
      str_squish() %>%                     # Trim extra spaces
      stri_trans_general("Latin-ASCII")    # Remove accents
  )

# Clean arrondissement names in GeoJSON
arr_map_clean <- arr_map %>%
  mutate(
    arrondissement_clean = NOM %>%
      str_replace_all("–", "-") %>%
      str_replace_all(" - ", "-") %>%
      str_squish() %>%
      stri_trans_general("Latin-ASCII")
  )

# Optional: check unmatched names
# setdiff(flow_cross_clean$arrondissement_clean, arr_map_clean$arrondissement_clean)

# Filter out off-island cities that aren’t in the map
valid_arrondissements <- arr_map_clean$arrondissement_clean
flow_cross_clean <- flow_cross_clean %>%
  filter(arrondissement_clean %in% valid_arrondissements)

# ====== STEP 3: JOIN SPATIAL DATA ======
map_data <- arr_map_clean %>%
  left_join(flow_cross_clean, by = "arrondissement_clean")

# ====== STEP 4: PLOT MAP ======
ggplot(map_data) +
  geom_sf(aes(fill = net_flow), color = "white", size = 0.3) +
  scale_fill_gradient2(
    low = "#d73027", mid = "#f0f0f0", high = "#1a9850",
    midpoint = 0,
    name = "Net Flow",
    na.value = "#cccccc"
  ) +
  labs(
    title = "BIXI Net Flow Mismatch by Arrondissement",
    subtitle = "Green = Net Inflow | Red = Net Outflow",
    fill = "Net Flow"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "right"
  )



```


```{r echo = FALSE}








```




## Weekday vs Weekend usage (proxy for commute vs leisure)

```{r echo = FALSE}

wk_split <- bixi %>% 
  mutate(day_type = if_else(weekday %in% c("Sat","Sun"), "Weekend", "Weekday")) %>%
  count(day_type, weekday)

ggplot(wk_split, aes(weekday, n, fill = day_type)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("#1b9e77","#d95f02")) +
  labs(title = "Weekday vs Weekend Rides",
       x = NULL, y = "Trips", fill = "")

```

## Station hotspots + flow imbalance
# This shows the popular stations, and the difference in rides completed here to rides started
# Hence giving us an imbalance on amount of bikes here in 2024

```{r echo = FALSE}

top_starts <- bixi %>% 
  count(STARTSTATIONNAME, sort = TRUE) %>% 
  slice_head(n = 10)

top_ends <- bixi %>% 
  count(ENDSTATIONNAME, sort = TRUE) %>% 
  slice_head(n = 10)

net_flow <- bixi %>% 
  # rename once so both columns share the same temporary field name
  mutate(station_start = STARTSTATIONNAME,
         station_end   = ENDSTATIONNAME) %>% 
  
  # count departures for each station
  count(station_start, name = "departures") %>% 
  
  # join with arrivals (note the renaming inside count())
  full_join(
    bixi %>% count(station_start = ENDSTATIONNAME, name = "arrivals"),
    by = "station_start"
  ) %>% 

  # clean up + compute net
  rename(station = station_start) %>% 
  replace_na(list(departures = 0, arrivals = 0)) %>% 
  mutate(net = departures - arrivals) %>% 
  arrange(desc(net))

# ── Preview ──────────────────────────────────────────────────────
print(top_starts)
print(top_ends)
print(net_flow %>% slice_head(n = 10))

```

## Trip‑duration statistics & distribution

```{r echo = FALSE}

summary(bixi$trip_min)  # min, median, mean, etc.

ggplot(bixi, aes(trip_min)) +
  geom_histogram(binwidth = 2, fill = "steelblue", alpha = 0.8) +
  coord_cartesian(xlim = c(0, 60)) +  # focus on <60 min
  labs(title = "Trip Duration Distribution (<60 min)",
       x = "Duration (minutes)", y = "Trips")

```

## Q5  Rough CO₂ savings estimate
# ------------------------------------------------
# Assumption: mean trip distance = 1.8 km (published by BIXI)
#            average car emits 0.192 kg CO₂ per km (Transport Canada)

```{r echo = FALSE}

km_per_trip      <- 1.8
kg_co2_per_km    <- 0.192

total_trips      <- nrow(bixi)
total_km         <- total_trips * km_per_trip
co2_saved_tonnes <- (total_km * kg_co2_per_km) / 1000   # kg ➜ tonnes

cat("\n=== Sustainability headline ===\n")
cat(sprintf("Trips: %s\nDistance (km): %.0f\nCO₂ avoided (tonnes): %.0f\n",
            comma(total_trips),
            total_km,
            co2_saved_tonnes))

```

## Most popular routes

```{r echo = FALSE}

get_top_routes <- function(data, n = 10, share = TRUE) {
  
  total <- nrow(data)                           # total rows in the file
  
  out <- data %>% 
    count(STARTSTATIONNAME, ENDSTATIONNAME,     # count every OD pair
          name  = "trips",
          sort  = TRUE) %>%                     # highest‑to‑lowest
    slice_head(n = n)                           # keep top‑n only
  
  if (share) {
    out <- out %>%
      mutate(share = round(100 * trips / total, 2))  # % of total trips
  }
  
  out <- out %>% 
    rename(start_station = STARTSTATIONNAME,
           end_station   = ENDSTATIONNAME)
  
  out
}

top10_routes <- get_top_routes(bixi, n = 10)

print(top10_routes)


```


## Number of rides per month

```{r}

rides_month <- bixi %>% 
  mutate(
    start_dt = as_datetime(STARTTIMEMS / 1000, tz = "America/Montreal"),
    month    = as.Date(floor_date(start_dt, "month"))   # << convert to Date
  ) %>% 
  count(month)

ggplot(rides_month, aes(month, n)) +
  geom_col(fill = "steelblue") +
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  scale_y_continuous(labels = comma) +
  labs(title = "BIXI 2024 – Monthly Trip Volume",
       x = NULL, y = "Trips") +
  theme_minimal()

```



